"""
–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤.
–§—É–Ω–∫—Ü–∏—è `repair_pkg` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π, –ø–∞–∫–µ—Ç–æ–≤ –∏ –æ—á–∏—Å—Ç–∫—É –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–æ–≤
–¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–∞–∫–µ—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ apt, dnf, pacman, flatpak, snap –∏ –¥—Ä—É–≥–∏–µ.
–§—É–Ω–∫—Ü–∏—è `detect_pkg_managers` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –ø–∞–∫–µ—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ.
–§—É–Ω–∫—Ü–∏—è `check_pkg_managers` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã.
–§—É–Ω–∫—Ü–∏—è `run_command` –∑–∞–ø—É—Å–∫–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    repair_pkg()
"""

from .utils import run_command, detect_pkg_managers, check_pkg_managers
from .colors import color_text


def repair_pkg():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á–∏ –∏ –ø–∞–∫–µ—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞–∫–µ—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.

    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞:
    - –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á–∏.
    - –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã.
    - –û—á–∏—â–∞–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏ –ø–∞–∫–µ—Ç–æ–≤.

    Returns:
        None
    """
    print(color_text("üõ†Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã...", "blue"))

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
    pkg_managers = detect_pkg_managers()

    if not check_pkg_managers(pkg_managers):
        return

    # –°–ª–æ–≤–∞—Ä—å —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    commands = {
        "epm": [
            (
                ["sudo", "epm", "check"],
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –ø–∞–∫–µ—Ç–æ–≤...",
            ),
            (["sudo", "epm", "clean"], "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "epm", "update"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
        ],
        "flatpak": [
            (["flatpak", "update"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö Flatpak –ø–∞–∫–µ—Ç–æ–≤..."),
            (["flatpak", "repair"], "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Flatpak –ø–∞–∫–µ—Ç–æ–≤..."),
        ],
        "snap": [
            (["sudo", "snap", "refresh"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö Snap –ø–∞–∫–µ—Ç–æ–≤..."),
            (
                ["sudo", "snap", "remove", "--purge"],
                "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Snap –ø–∞–∫–µ—Ç–æ–≤...",
            ),
        ],
        "dnf": [
            (["sudo", "dnf", "makecache"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ DNF..."),
            (
                ["sudo", "dnf", "upgrade", "--assumeyes"],
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
            (
                ["sudo", "dnf", "autoremove", "--assumeyes"],
                "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
        ],
        "pacman": [
            (
                [
                    "sudo",
                    "pacman",
                    "-Sy",
                    "--needed",
                    "--noconfirm",
                    "archlinux-keyring",
                ],
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π Arch Linux...",
            ),
            (
                ["sudo", "pacman", "-Su", "--noconfirm", "pacman-contrib"],
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pacman-contrib...",
            ),
            (["sudo", "pacman", "-Fy"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "paccache", "-r"], "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–æ–≤..."),
        ],
        "apk": [
            (["sudo", "apk", "update"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "apk", "upgrade"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "apk", "cache", "clean"], "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
        ],
        "xbps": [
            (["sudo", "xbps-install", "-S"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "xbps-install", "-u"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."),
            (["sudo", "xbps-remove", "-o"], "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."),
        ],
        "apt": [
            (["sudo", "apt", "update"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
            (
                ["sudo", "apt", "upgrade", "--yes"],
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
            (
                ["sudo", "apt", "autoremove", "--yes"],
                "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
        ],
        "apt-get": [
            (["sudo", "apt-get", "update"], "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."),
            (
                ["sudo", "apt-get", "upgrade", "--yes"],
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
            (
                ["sudo", "apt-get", "autoremove", "--yes"],
                "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...",
            ),
        ],
    }

    for manager in pkg_managers:
        if manager in commands:
            print(color_text(f"üîß –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è {manager}...", "cyan"))
            for command, message in commands[manager]:
                try:
                    print(color_text(message, "cyan"))
                    run_command(command)
                except RuntimeError as e:
                    print(
                        color_text(
                            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã '{' '.join(command)}': {e}",
                            "red",
                        )
                    )
                    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞

    print(color_text("üéâ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!", "green"))
